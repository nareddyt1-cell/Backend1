<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pancreatic Proenzyme Sequence Analyzer</title>

    <!-- Mol* CSS -->
    <link href="https://unpkg.com/molstar/build/viewer/molstar.css" rel="stylesheet" />

    <!-- Mol* JS -->
    <script src="https://unpkg.com/molstar/build/viewer/molstar.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f9f9f9;
            padding: 40px;
        }
        textarea {
            width: 100%;
            height: 180px;
            font-family: monospace;
            white-space: pre-wrap;
            padding: 12px;
            margin-bottom: 15px;
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        pre, div {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ccc;
            margin-top: 20px;
        }
        .mutation {
            color: red;
            font-weight: bold;
        }
        #viewer {
            width: 100%;
            height: 520px;
        }
    </style>
</head>
<body>

<h1>Pancreatic Proenzyme Sequence Analyzer</h1>

<label>Normal Proenzyme Sequence</label>
<textarea id="normal"></textarea>

<label>Damaged Proenzyme Sequence</label>
<textarea id="damaged"></textarea>

<button id="analyzeBtn" onclick="analyze()">Analyze Sequence</button>

<h3>Sequence Comparison</h3>
<pre id="sequenceView"></pre>

<div id="results"></div>

<h3>Mutation Effects</h3>
<pre id="mutationEffects"></pre>

<h3>AlphaFold Structure</h3>
<div id="viewer"></div>

<script>
let molstarViewer = null;

function highlightMutations(normal, damaged, diffs) {
    let out = "";
    for (let i = 0; i < normal.length; i++) {
        const mut = diffs.find(x => x.position === i + 1);
        out += mut ? `<span class="mutation">${damaged[i]}</span>` : (damaged[i] || "-");
        if ((i + 1) % 50 === 0) out += "\n";
    }
    return out;
}

async function loadStructure(uniprotId) {
    if (!molstarViewer) {
        molstarViewer = await molstar.Viewer.create("viewer", {
            layoutIsExpanded: true,
            layoutShowControls: true,
            backgroundColor: 0xFFFFFF
        });
    }

    molstarViewer.plugin.clear();

    const url = `https://alphafold.ebi.ac.uk/files/AF-${uniprotId}-F1-model_v4.cif`;

    await molstarViewer.loadStructureFromUrl(
        url,
        "mmcif",
        false
    );
}

async function analyze() {
    const btn = document.getElementById("analyzeBtn");
    btn.disabled = true;

    try {
        const res = await fetch("/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                normal_sequence: normal.value.trim(),
                damaged_sequence: damaged.value.trim()
            })
        });

        const data = await res.json();

        sequenceView.innerHTML =
            highlightMutations(normal.value, damaged.value, data.differences);

        results.innerHTML = `
            <b>Total Mutations:</b> ${data.summary.total_mutations}<br>
            <b>Functional Likelihood:</b> ${data.summary.functional_likelihood}%
        `;

        mutationEffects.textContent =
            data.mutation_effects.map(m =>
                `Position ${m.position}: ${m.effect}`
            ).join("\n");

        if (data.alphafold_id) {
            await loadStructure(data.alphafold_id);
        }

    } catch (err) {
        alert("Failed to connect to backend");
        console.error(err);
    } finally {
        btn.disabled = false;
    }
}
</script>

</body>
</html>
