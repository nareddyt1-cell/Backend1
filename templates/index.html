<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pancreatic Proenzyme Sequence Analyzer</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/molstar/build/viewer/molstar.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    margin: 20px;
}

h1 { text-align: center; }

textarea {
    width: 100%;
    height: 140px;
    font-family: monospace;
    font-size: 14px;
    padding: 10px;
    white-space: pre-wrap;
    word-wrap: break-word;
}

button {
    padding: 12px 20px;
    font-size: 16px;
    margin-top: 10px;
    cursor: pointer;
}

.section {
    background: white;
    padding: 20px;
    margin-top: 20px;
    border-radius: 8px;
}

#molecule-viewer {
    width: 100%;
    height: 500px;
}
</style>
</head>

<body>

<h1>Pancreatic Proenzyme Sequence Analyzer</h1>

<div class="section">
    <h3>Normal Enzyme Sequence</h3>
    <textarea id="normalSeq"></textarea>

    <h3>Damaged Enzyme Sequence</h3>
    <textarea id="damagedSeq"></textarea>

    <button onclick="analyze()">Analyze Sequence</button>
</div>

<div class="section">
    <h3>Detected Mutations</h3>
    <div id="mutations"></div>
</div>

<div class="section">
    <h3>Functional Likelihood (%)</h3>
    <canvas id="functionChart"></canvas>
</div>

<div class="section">
    <h3>Lost Enzyme Capabilities</h3>
    <ul id="lostFunctions"></ul>
</div>

<div class="section">
    <h3>AlphaFold 3D Structure</h3>
    <div id="molecule-viewer"></div>
</div>

<script>
let chart;

async function analyze() {
    const normalSeq = document.getElementById("normalSeq").value;
    const damagedSeq = document.getElementById("damagedSeq").value;

    const response = await fetch("https://backend-688r.onrender.com/analyze", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({normal_sequence: normalSeq, damaged_sequence: damagedSeq})
    });

    const data = await response.json();
    renderResults(data);
}

function renderResults(data) {
    document.getElementById("mutations").innerHTML =
        data.mutations.length
        ? data.mutations.map(m => `Position ${m.position}: ${m.normal} â†’ ${m.damaged}`).join("<br>")
        : "No mutations detected";

    document.getElementById("lostFunctions").innerHTML =
        data.lost_functions.length
        ? data.lost_functions.map(f => `<li>${f}</li>`).join("")
        : "<li>No major functional loss predicted</li>";

    renderChart(data.functionality);
    loadStructure(data.uniprot_id);
}

function renderChart(values) {
    const ctx = document.getElementById("functionChart");

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type: "doughnut",
        data: {
            labels: ["Normal", "Damaged"],
            datasets: [{
                data: [values.normal, values.damaged],
                backgroundColor: ["#2ecc71", "#e74c3c"]
            }]
        }
    });
}

function loadStructure(uniprotId) {
    const viewerDiv = document.getElementById("molecule-viewer");
    viewerDiv.innerHTML = "";

    if (!uniprotId) {
        viewerDiv.innerHTML = "<p>No AlphaFold structure available for this enzyme.</p>";
        return;
    }

    molstar.Viewer.create("molecule-viewer", { layoutIsExpanded: true })
        .then(viewer => {
            viewer.loadStructureFromUrl(
                `https://alphafold.ebi.ac.uk/files/AF-${uniprotId}-F1-model_v4.cif`,
                "mmcif"
            ).catch(err => {
                viewerDiv.innerHTML = "<p>Failed to load AlphaFold structure.</p>";
                console.error(err);
            });
        });
}
</script>

</body>
</html>
