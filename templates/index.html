<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pancreatic Proenzyme Sequence Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f9f9f9;
            padding: 40px;
        }
        h1 { margin-bottom: 20px; }
        textarea {
            width: 100%;
            height: 150px;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.3;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            margin-bottom: 15px;
            padding: 10px;
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        #sequenceView {
            font-family: monospace;
            white-space: pre-wrap;
            background: #fff;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ccc;
            margin-top: 20px;
        }
        #results {
            background: #fff;
            padding: 15px;
            margin-top: 20px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        .mutation {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>

<h1>Pancreatic Proenzyme Sequence Analyzer</h1>

<label>Normal Proenzyme Sequence:</label>
<textarea id="normal" placeholder="Paste normal enzyme sequence here"></textarea>

<label>Damaged Proenzyme Sequence:</label>
<textarea id="damaged" placeholder="Paste damaged enzyme sequence here"></textarea>

<button id="analyzeBtn" onclick="analyze()">Analyze Sequence</button>

<h3>Sequence Comparison</h3>
<pre id="sequenceView"></pre>

<div id="results"></div>

<h3>Functional Likelihood Graph</h3>
<canvas id="likelihoodChart" width="400" height="200"></canvas>

<script>
let chartInstance = null; // store chart globally

function highlightMutations(normal, damaged, differences) {
    let damagedView = "";
    for (let i = 0; i < normal.length; i++) {
        const diff = differences.find(d => d.position === i + 1);
        if (diff) {
            damagedView += `<span class="mutation">${damaged[i]}</span>`;
        } else {
            damagedView += damaged[i] || "-";
        }
        if ((i+1) % 50 === 0) damagedView += "\n";
    }
    let normalWrapped = "";
    for (let i = 0; i < normal.length; i++) {
        normalWrapped += normal[i];
        if ((i+1) % 50 === 0) normalWrapped += "\n";
    }
    return `Normal:  ${normalWrapped}\nDamaged: ${damagedView}`;
}

async function analyze() {
    const btn = document.getElementById("analyzeBtn");
    const normal = document.getElementById("normal").value.trim();
    const damaged = document.getElementById("damaged").value.trim();
    const resultsDiv = document.getElementById("results");
    const sequenceDiv = document.getElementById("sequenceView");

    if (!normal || !damaged) {
        resultsDiv.innerHTML = "Please enter both sequences.";
        return;
    }

    // Disable button to prevent multiple clicks
    btn.disabled = true;
    resultsDiv.innerHTML = "Analyzing...";
    sequenceDiv.innerHTML = "";

    try {
        const response = await fetch("https://backend-688r.onrender.com/analyze", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ normal_sequence: normal, damaged_sequence: damaged })
        });

        const data = await response.json();

        // Highlight mutations
        sequenceDiv.innerHTML = highlightMutations(normal, damaged, data.differences);

        // Show results
        let html = `<p><strong>Total Mutations:</strong> ${data.summary.total_mutations}</p>`;
        html += `<p><strong>Functional Likelihood:</strong> ${data.summary.functional_likelihood}%</p>`;

        if (data.matched_enzymes.length > 0) {
            html += "<h4>Identified Digestive Proenzymes</h4><ul>";
            data.matched_enzymes.forEach(e => {
                html += `<li>${e.name} (${e.gene}) â€“ UniProt: ${e.accession}</li>`;
            });
            html += "</ul>";
        }
        resultsDiv.innerHTML = html;

        // Destroy previous chart if exists
        if (chartInstance) chartInstance.destroy();

        // Render chart dynamically
        const ctx = document.getElementById("likelihoodChart").getContext("2d");
        chartInstance = new Chart(ctx, {
            type: "bar",
            data: {
                labels: ["Normal", "Damaged"],
                datasets: [{
                    label: "Functional Likelihood (%)",
                    data: [data.likelihoods.normal, data.likelihoods.damaged],
                    backgroundColor: ["#4caf50", "#f44336"]
                }]
            },
            options: { scales: { y: { min: 0, max: 100 } } }
        });

    } catch (err) {
        console.error(err);
        resultsDiv.innerHTML = "Error connecting to backend.";
    } finally {
        btn.disabled = false; // re-enable button
    }
}
</script>

</body>
</html>
