<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pancreatic Proenzyme Sequence Analyzer</title>

    <script src="https://unpkg.com/molstar/build/viewer/molstar.js"></script>

    <style>
        body { font-family: Arial; max-width: 1100px; margin: auto; }
        textarea {
            width: 100%;
            height: 220px;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            margin-top: 10px;
        }
        .section { margin-top: 30px; }
        .percent-ring {
            font-size: 28px;
            font-weight: bold;
            color: #2c7;
        }
        #viewer {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>

<h1>Pancreatic Proenzyme Sequence Analyzer</h1>

<div class="section">
    <h3>Reference Sequence</h3>
    <textarea id="normal"></textarea>
</div>

<div class="section">
    <h3>Damaged Sequence</h3>
    <textarea id="damaged"></textarea>
</div>

<button type="button" onclick="analyze()">Analyze Sequence</button>

<div class="section">
    <h3>Identified Enzyme</h3>
    <div id="enzyme">—</div>
</div>

<div class="section">
    <h3>Mutation Locations</h3>
    <pre id="mutations">—</pre>
</div>

<div class="section">
    <h3>Functional Likelihood</h3>
    <div class="percent-ring" id="functionality">—</div>
</div>

<div class="section">
    <h3>Lost Biological Function</h3>
    <div id="lost-function">—</div>
</div>

<div class="section">
    <h3>AlphaFold Structure</h3>
    <div id="viewer"></div>
</div>

<script>
async function analyze() {
    const normal = document.getElementById("normal").value;
    const damaged = document.getElementById("damaged").value;

    const res = await fetch("https://backend-688r.onrender.com/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            normal_sequence: normal,
            damaged_sequence: damaged
        })
    });

    const data = await res.json();

    document.getElementById("enzyme").textContent = data.identified_enzyme;
    document.getElementById("functionality").textContent =
        data.functionality_percent + "% functional";
    document.getElementById("lost-function").textContent = data.lost_function;

    document.getElementById("mutations").textContent =
        data.mutations.map(
            m => `Position ${m.position}: ${m.from} → ${m.to}`
        ).join("\n");

    loadStructure(data.uniprot_id);
}

async function loadStructure(uniprot) {
    const viewerDiv = document.getElementById("viewer");
    viewerDiv.innerHTML = "";

    if (!uniprot) {
        viewerDiv.textContent = "No AlphaFold structure available.";
        return;
    }

    const url = `https://alphafold.ebi.ac.uk/files/AF-${uniprot}-F1-model_v4.cif`;
    const head = await fetch(url, { method: "HEAD" });

    if (!head.ok) {
        viewerDiv.textContent = "AlphaFold structure not available.";
        return;
    }

    molstar.Viewer.create("viewer").then(v =>
        v.loadStructureFromUrl(url, "mmcif")
    );
}
</script>

</body>
</html>
